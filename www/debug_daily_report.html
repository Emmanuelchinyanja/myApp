<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Report Debug Test</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div style="padding: 20px; max-width: 800px; margin: 0 auto;">
        <h1>Daily Report Debug Test</h1>
        
        <div class="report-filters" style="margin-bottom: 20px;">
            <div class="form-group">
                <label>Select Date</label>
                <input type="date" id="dailyReportDate">
            </div>
            <button class="btn btn-primary" onclick="testGenerateReport()">
                <i class="fas fa-file-pdf"></i> Test Generate Report
            </button>
            <button class="btn btn-secondary" onclick="setupTestData()">
                <i class="fas fa-database"></i> Setup Test Data
            </button>
            <button class="btn btn-warning" onclick="clearData()">
                <i class="fas fa-trash"></i> Clear Data
            </button>
        </div>
        
        <div id="dailyReportOutput" class="report-output"></div>
        
        <div id="debugOutput" style="margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 5px;">
            <h4>Debug Output:</h4>
            <div id="debugLog"></div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        let orders = [];
        let products = [];
        
        function debugLog(message) {
            console.log(message);
            $('#debugLog').append('<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>');
        }
        
        function setupTestData() {
            debugLog('Setting up test data...');
            
            // Sample orders for today
            const today = new Date().toISOString();
            const sampleOrders = [
                {
                    id: 1,
                    customerName: 'John Doe',
                    staffName: 'Alice Johnson',
                    date: today,
                    total: 45000,
                    paymentMethod: 'cash',
                    status: 'completed'
                },
                {
                    id: 2,
                    customerName: 'Jane Smith',
                    staffName: 'Bob Wilson',
                    date: today,
                    total: 70000,
                    paymentMethod: 'mobile',
                    status: 'completed'
                },
                {
                    id: 3,
                    customerName: 'Mike Brown',
                    staffName: 'Alice Johnson',
                    date: today,
                    total: 25000,
                    paymentMethod: 'card',
                    status: 'completed'
                }
            ];
            
            localStorage.setItem('orders', JSON.stringify(sampleOrders));
            orders = sampleOrders;
            
            debugLog('Test data setup complete. Orders: ' + orders.length);
            showToast('Test data setup complete', 'success');
        }
        
        function clearData() {
            localStorage.removeItem('orders');
            orders = [];
            $('#dailyReportOutput').html('');
            $('#debugLog').html('');
            debugLog('Data cleared');
            showToast('Data cleared', 'info');
        }
        
        function testGenerateReport() {
            debugLog('=== Starting Report Generation Test ===');
            
            const reportDate = $('#dailyReportDate').val();
            const output = $('#dailyReportOutput');
            
            debugLog('Report date: ' + reportDate);
            debugLog('Orders available: ' + orders.length);
            debugLog('Output element found: ' + (output.length > 0));
            
            if (!reportDate) {
                debugLog('ERROR: No date selected');
                showToast('Please select a date', 'warning');
                return;
            }

            // Load orders from localStorage
            const savedOrders = localStorage.getItem('orders');
            if (savedOrders) {
                orders = JSON.parse(savedOrders);
                debugLog('Loaded ' + orders.length + ' orders from localStorage');
            }

            const filteredOrders = orders.filter(o => {
                if (!o.date) {
                    debugLog('WARNING: Order missing date: ' + JSON.stringify(o));
                    return false;
                }
                const orderDate = new Date(o.date).toDateString();
                const selectedDate = new Date(reportDate).toDateString();
                const matches = orderDate === selectedDate;
                debugLog('Order ' + o.id + ': ' + orderDate + ' vs ' + selectedDate + ' = ' + matches);
                return matches;
            });

            debugLog('Filtered orders: ' + filteredOrders.length);

            if (filteredOrders.length === 0) {
                debugLog('No transactions found for this date');
                output.html('<p style="text-align:center; padding:40px; color:#6b7280;">No transactions found for this date</p>');
                showToast('No transactions found for this date', 'info');
                return;
            }

            // Group by payment method
            const paymentBreakdown = {};
            filteredOrders.forEach(order => {
                const method = order.paymentMethod || 'cash';
                if (!paymentBreakdown[method]) {
                    paymentBreakdown[method] = { count: 0, total: 0 };
                }
                paymentBreakdown[method].count++;
                paymentBreakdown[method].total += order.total || 0;
            });

            debugLog('Payment breakdown: ' + JSON.stringify(paymentBreakdown));

            const totalRevenue = filteredOrders.reduce((sum, o) => sum + (o.total || 0), 0);
            const avgOrder = Math.round(totalRevenue / filteredOrders.length);

            debugLog('Total Revenue: ' + totalRevenue);
            debugLog('Average Order: ' + avgOrder);

            const reportHTML = `
                <h3>DAILY SALES REPORT</h3>
                <p style="color:var(--text-secondary); margin-bottom:20px;">Date: ${new Date(reportDate).toLocaleDateString()}</p>
                
                <div class="stats-grid" style="margin-bottom:20px;">
                    <div class="stat-card">
                        <i class="fas fa-shopping-bag"></i>
                        <h4>Total Orders</h4>
                        <p>${filteredOrders.length}</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-dollar-sign"></i>
                        <h4>Total Revenue</h4>
                        <p>MWK ${totalRevenue.toLocaleString()}</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-chart-line"></i>
                        <h4>Avg Order</h4>
                        <p>MWK ${avgOrder.toLocaleString()}</p>
                    </div>
                </div>

                <h4 style="margin-bottom:10px;">Payment Method Breakdown</h4>
                <table class="report-table" style="margin-bottom:20px;">
                    <thead>
                        <tr>
                            <th>Method</th>
                            <th>Orders</th>
                            <th>Total Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(paymentBreakdown).map(([method, data]) => {
                            return `
                                <tr>
                                    <td style="text-transform:capitalize;">${method}</td>
                                    <td>${data.count}</td>
                                    <td>MWK ${data.total.toLocaleString()}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>

                <h4 style="margin-bottom:10px;">Transaction Details</h4>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Time</th>
                            <th>Customer/Staff</th>
                            <th>Amount</th>
                            <th>Payment</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredOrders.map(order => {
                            return `
                                <tr>
                                    <td>${order.id}</td>
                                    <td>${new Date(order.date).toLocaleTimeString()}</td>
                                    <td>${order.customerName || order.staffName || 'N/A'}</td>
                                    <td>MWK ${(order.total || 0).toLocaleString()}</td>
                                    <td style="text-transform:capitalize;">${order.paymentMethod || 'cash'}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>

                <div class="export-buttons">
                    <button class="btn btn-primary" onclick="alert('Preview function would go here')">
                        <i class="fas fa-eye"></i> Preview Report
                    </button>
                    <button class="btn btn-export-pdf" onclick="alert('PDF export would go here')">
                        <i class="fas fa-file-pdf"></i> Download PDF
                    </button>
                    <button class="btn btn-export-excel" onclick="alert('Excel export would go here')">
                        <i class="fas fa-file-excel"></i> Export to Excel
                    </button>
                </div>
            `;
            
            debugLog('Setting report HTML...');
            output.html(reportHTML);
            debugLog('Report generated successfully');
            
            showToast('âœ“ Daily report generated successfully', 'success');
            debugLog('=== Report Generation Test Complete ===');
        }
        
        function showToast(message, type = 'success') {
            const toast = $('#toast');
            if (toast.length) {
                toast.text(message)
                    .removeClass('success error warning info')
                    .addClass(type)
                    .addClass('show');
                
                setTimeout(() => {
                    toast.removeClass('show');
                }, 3000);
            }
        }
        
        // Set today's date by default
        $(document).ready(function() {
            const today = new Date().toISOString().split('T')[0];
            $('#dailyReportDate').val(today);
            debugLog('Page loaded. Default date set to: ' + today);
            
            // Try to load existing data
            const savedOrders = localStorage.getItem('orders');
            if (savedOrders) {
                orders = JSON.parse(savedOrders);
                debugLog('Found ' + orders.length + ' existing orders in localStorage');
            } else {
                debugLog('No existing orders found in localStorage');
            }
        });
    </script>
</body>
</html>
